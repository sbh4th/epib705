---
title: "Bias Analysis"
format: 
  revealjs:
    theme: [default, custom.scss]
    width: 1600
    height: 900
    slide-number: true
    html-math-method: mathjax
editor: visual
bibliography: bias-analysis.bib
csl: vancouver-author-date.csl
filters:
  - parse-latex
---

```{r setup, echo=F}
library(here)
library(tidyverse)
library(kableExtra)
library(episensr)
library(countdown)
library(emo)
library(ggplot2)
library(patchwork)
```

## Overview {.h2center}

### Why Bias Analysis?

<br>

### Deterministic Bias Analysis

#### Unmeasured confounding

#### Misclassification

#### Selection bias

<br>

### Probabilistic Bias Analysis

<br>

### Record-level Implementation

<br>

### Summary

## Unmeasured Confounding

## Introduction

How do misclassification, selection bias, and unmeasured confounding create bias in parameter estimation?

::: incremental
> By assuming that all errors are random and that any modeling assumptions (such as homogeneity) are correct, all uncertainty about the effect of errors on estimates is subsumed within conventional standard deviations for the estimates (standard errors), such as those given in earlier chapters (which assume no measurement error), and any discrepancy between an observed association and the target effect may be attributed to chance alone - (RGL, p.346)

-   Bias analysis is an attempt to "safeguard against failure to attribute effects to exposure rather than systematic error"
:::

## What are we concerned about?

```{r, echo=F, out.width="80%"}
knitr::include_graphics(here("images", "bias-DAG.pdf"))
```

## Example

> Several potential limitations of the present investigation must be considered in drawing conclusions from the results. In particular, AMD was ascertained only in one eye, resulting in a possible underestimation of AMD cases; however, studies have shown that AMD development is typically symmetric. Further, AMD was identified using nonmydriatic fundus photography without dilating the pupils, which may have led to potential misclassification of cases. In estimating milk and fish intake, the food frequency questionnaire used in this study was not validated and the measurement error was unknown. The serum 25-hydroxyvitamin D values would reflect sun exposure and food intake over recent weeks, rather than years, which would have enhanced random measurement error. Therefore, **associations reported are likely to be biased toward the null.**[^1]

[^1]: See @Parekh:2007aa

## 

::: center
Which line is longer?
:::

```{r, echo=F, out.width="80%"}
knitr::include_graphics(here("images", "illusion-1.jpg"))
```

## 

Intuitions are difficult to overcome.

```{r, echo=F}
knitr::include_graphics(here("images", "illusion-2.png"))
```

## Record level implementation

-   Step 1: Identify the Source of Bias
-   Step 2: Select the Bias Parameters
-   Step 3: Assign Probability Distributions to Each Bias Parameter
-   Step 4: Use Simple Bias Analysis Methods to Incorporate Uncertainty in the Bias Parameters and Random Error
    -   Step 4a: Randomly Sample from the Bias Parameter Distributions
    -   Step 4b: Use Simple Bias Analysis Methods and Incorporate Uncertainty and Conventional Random Error
    -   Step 4c: Sample the Bias-Adjusted Effect Estimate
-   Step 5: Save the Bias-Adjusted Estimate and Repeat Steps 4a--c

## Overview {.h2center}

### [Why Bias Analysis?]{.gray}

<br>

### **Deterministic Bias Analysis**

#### **Unmeasured confounding**

#### [Measurement error]{.gray}

#### [Selection bias]{.gray}

<br>

### [Probabilistic Bias Analysis]{.gray}

<br>

### [Record-level Implementation]{.gray}

<br>

### [Summary]{.gray}

## Unmeasured Confounding

Example of Sensitivity Analysis for Unmeasured Confounding

-   Crude OR: $OR_{DX+}=(45\times945)/(94\times257)=1.76$

| Disease Status | X=1 | X=0  | Total |
|----------------|-----|------|-------|
| Cases (D=1)    | 45  | 94   | 139   |
| Controls (D=0) | 257 | 945  | 1202  |
| Total          | 302 | 1039 | 1341  |

-   We think this is confounded by smoking $(Z)$, but we did not measure it.

-   How can we quantify the potential effect of failing to adjust for $Z$?

## Unmeasured Confounding

<br>

::: columns
::: {.column width="52%"}
| Disease Status | X=1 | X=0  | Total |
|----------------|-----|------|-------|
| Cases (D=1)    | 45  | 94   | 139   |
| Controls (D=0) | 257 | 945  | 1202  |
| Total          | 302 | 1039 | 1341  |
:::

::: {.column width="2%"}
:::

::: {.column width="46%"}
Crude OR:\
$OR_{DX+}=\frac{(45\times945)}{(94\times257)}=1.76$
:::
:::

<br>

-   Likely confounded by smoking $(Z)$, but we did not measure it.

-   How can we quantify failing to adjust for $Z$?

## Example: Sensitivity Analysis for Unmeasured Confounding

## Data Layout for Dichotomous Unmeasured Confounder

::: columns
::: {.column width="35%"}
|       | X=1   | X=0   | Total |
|-------|-------|-------|-------|
| D=1   | A~11~ | A~01~ | M~11~ |
| D=0   | B~11~ | B~01~ | M~01~ |
| Total | N~11~ | N~01~ | N~+1~ |

: **Z=1 Smokers**
:::

::: {.column width="40%"}
| X=1           | X=0           | Total         |
|---------------|---------------|---------------|
| A~1+~ - A~11~ | A~0+~ - A~01~ | M~A+~ - M~11~ |
| B~1+~ - B~11~ | B~0+~ - B~01~ | M~B+~ - M~01~ |
| N~1+~ - N~11~ | N~0+~ - N~01~ | N~++~ - N~+1~ |

: **Z=0 Non-smokers**
:::

::: {.column width="25%"}
| X=1   | X=0   | Total |
|-------|-------|-------|
| A~1+~ | A~0+~ | M~A+~ |
| B~1+~ | B~0+~ | M~B+~ |
| N~1+~ | N~0+~ | N~++~ |

: **Total**
:::
:::

## Where did this come from?

::: columns
::: {.column width="65%"}
> If a causal agent, *A*, with no causal effect upon the risk of a disease, nevertheless, because of a positive correlation with some other causal agent, *B*, shows an apparent risk, *r*, for those exposed to *A*, relative to those not so exposed, then the prevalence of *B*, among those exposed to *A*, relative to the prevalence among those not so exposed, must be greater than *r*.
:::

::: {.column width="5%"}
:::

::: {.column width="30%"}
```{r, echo=F, out.width="150%"}
knitr::include_graphics(here("images", "cornfield.png"))
```

Contribution of Cornfield et al. (1959, J Nat Canc Inst).
:::
:::

## Data Layout for Dichotomous Unmeasured Confounder

::: columns
::: {.column width="35%"}
|       | X=1   | X=0   | Total |
|-------|-------|-------|-------|
| D=1   | A~11~ | A~01~ | M~11~ |
| D=0   | B~11~ | B~01~ | M~01~ |
| Total | N~11~ | N~01~ | N~+1~ |

: **Z=1 Smokers**
:::

::: {.column width="40%"}
| X=1           | X=0           | Total         |
|---------------|---------------|---------------|
| A~1+~ - A~11~ | A~0+~ - A~01~ | M~A+~ - M~11~ |
| B~1+~ - B~11~ | B~0+~ - B~01~ | M~B+~ - M~01~ |
| N~1+~ - N~11~ | N~0+~ - N~01~ | N~++~ - N~+1~ |

: **Z=0 Non-smokers**
:::

::: {.column width="25%"}
| X=1   | X=0   | Total |
|-------|-------|-------|
| A~1+~ | A~0+~ | M~A+~ |
| B~1+~ | B~0+~ | M~B+~ |
| N~1+~ | N~0+~ | N~++~ |

: **Total**
:::
:::

-   To adjust for smoking we need stratum-specific ORs.

-   We can write the exposure-disease OR \textbf{within strata} of $Z$ $\left(OR_{DXZ}\right)$ as:

:::columns

::: {.column width="35%"}
$OR_{DX_{Z=1}}=\dfrac{A_{11}B_{01}}{A_{01}B_{11}}$
:::
::: {.column width="65%"}
$OR_{DX_{Z=0}}=\dfrac{\left(A_{1+}-A_{11}\right)\left(B_{0+}-B_{01}\right)}{\left(A_{0+}-A_{01}\right)\left(B_{1+}-B_{11}\right)}$
:::

:::

## Data Layout for Dichotomous Unmeasured Confounder

::: columns
::: {.column width="35%"}
|       | X=1                | X=0                | Total |
|-------|--------------------|--------------------|-------|
| D=1   | <mark>A~11~</mark> | <mark>A~01~</mark> | M~11~ |
| D=0   | <mark>B~11~</mark> | <mark>B~01~</mark> | M~01~ |
| Total | N~11~              | N~01~              | N~+1~ |

: **Z=1 Smokers**
:::

::: {.column width="40%"}
| X=1           | X=0           | Total         |
|---------------|---------------|---------------|
| A~1+~ - A~11~ | A~0+~ - A~01~ | M~A+~ - M~11~ |
| B~1+~ - B~11~ | B~0+~ - B~01~ | M~B+~ - M~01~ |
| N~1+~ - N~11~ | N~0+~ - N~01~ | N~++~ - N~+1~ |

: **Z=0 Non-smokers**
:::

::: {.column width="25%"}
| X=1 | X=0  | Total |
|-----|------|-------|
| 45  | 94   | 139   |
| 257 | 945  | 1202  |
| 302 | 1039 | 1341  |

: **Total**
:::
:::

We already know the marginal totals, so only 4 quantities to estimate.

-   These values may be generated by specifying values for the prevalence of smoking in each exposure group and the association between smoking and disease.

-   The (unknown) smoking prevalence in exposure strata are:

    $P_{Z1}=N_{11}/N_{1+}$ and $P_{Z0}=N_{01}/N_{0+}$

## Ex

```{r tab, echo=F, include=F}
z1 <- rep(1,9)
x1 <- rep(seq(1:3),3)
d <- rep(seq(1:3), each=3)
c1 <- c("A~11~", "A01", "M11",
        "B11", "B01", "M01",
        "N11", "N01", "N+1")
df <- data.frame(z1, x1, d, c1)
df1 <- df %>% 
  pivot_wider(names_from = x1, values_from = c(c1,z1)) %>%
  select(d:c1_3)
z0 <- rep(0,9)
c0 <- c("A11", "A01", "M11",
        "B11", "B01", "M01",
        "N11", "N01", "N+1")

df <- data.frame(z0, x1, d, c0)
df0 <- df %>%
  pivot_wider(names_from = x1, values_from = c(c0,z0)) %>%
  select(d:c0_3)
zt <- rep(2,9)
ct <- c("A11", "A01", "M11",
        "B11", "B01", "M01",
        "N11", "N01", "N+1")

df <- data.frame(zt, x1, d, ct)
dft <- df %>%
  pivot_wider(names_from = x1, values_from = c(ct,zt)) %>%
  select(d:ct_3)

tuc <- df1 %>%
  inner_join(df0) %>%
  inner_join(dft)

kbl(tuc, col.names = c("Case", "X=1", "X=0", 
  "Total", "X=1", "X=0", "Total", "X=1", "X=0", "Total")) %>% kable_styling() %>%
    add_header_above(c(" " = 1, "Z=1 Smokers" = 3, 
      "Z=0 Non-smokers" = 3, "Total" = 3))
```

## Worked example

-   Suppose we know from external studies that the prevalence of smoking is 70% among those occupationally exposed to resins and 50% among those unexposed in this population.

```{=tex}
\begin{tabular}{cccccccccccc}
\hline 
 & \multicolumn{3}{c}{{\small{}Z=1 Smokers}} &  & \multicolumn{3}{c}{{\small{}Z=0 Non-smokers}} &  & \multicolumn{3}{c}{{\small{}Total}}\tabularnewline
\cline{2-4} \cline{3-4} \cline{4-4} \cline{6-8} \cline{7-8} \cline{8-8} \cline{10-12} \cline{11-12} \cline{12-12} 
 & {\small{}X=1} & {\small{}X=0} & {\small{}Total} &  & {\small{}X=1} & {\small{}X=0} & {\small{}Total} &  & {\small{}X=1} & {\small{}X=0} & {\small{}Total}\tabularnewline
\hline 
{\small{}D=1} & \textbf{\small{}$\mathbf{{\scriptstyle A_{11}}}$} & \textbf{\small{}$\mathbf{{\scriptstyle A_{01}}}$} & {\small{}${\scriptstyle M_{11}}$} &  & {\small{}${\scriptstyle 45-A_{11}}$} & {\small{}${\scriptstyle 94-A_{01}}$} & {\small{}${\scriptstyle 139-M_{11}}$} &  & 45 & 94 & 139\tabularnewline
{\small{}D=0} & \textbf{\textcolor{red}{\small{}$\mathbf{{\scriptstyle B_{11}}}$}} & \textbf{\textcolor{blue}{\small{}$\mathbf{{\scriptstyle B_{01}}}$}} & {\small{}${\scriptstyle M_{01}}$} &  & {\small{}${\scriptstyle 257-B_{11}}$} & {\small{}${\scriptstyle 945-B_{01}}$} & {\small{}${\scriptstyle 1202-M_{01}}$} &  & \textcolor{red}{257} & \textcolor{blue}{945} & 1202\tabularnewline
\hline 
{\small{}Total} & {\small{}${\scriptstyle N_{11}}$} & {\small{}${\scriptstyle N_{01}}$} & {\small{}${\scriptstyle N_{+1}}$} &  & {\small{}${\scriptstyle 302-N_{11}}$} & {\small{}${\scriptstyle 1039-N_{01}}$} & {\small{}${\scriptstyle 1341-N_{+1}}$} &  & 302 & 1039 & 1341\tabularnewline
& & & & & & & & & & & \tabularnewline
\end{tabular}
```
-   Our estimates of $B_{11}$ and $B_{01}$ are now:

$B_{11}=P_{Z1}B_{1+}=(.7)(257)\approx180$

$B_{01}=P_{Z0}B_{0+}=(.5)(945)\approx473$

## Will this work?

```{=tex}
\begin{tabular}{cccccccccccc}
\hline 
 & \multicolumn{3}{c}{{\small{}Z=1 Smokers}} &  & \multicolumn{3}{c}{{\small{}Z=0 Non-smokers}} &  & \multicolumn{3}{c}{{\small{}Total}}\tabularnewline
\cline{2-4} \cline{3-4} \cline{4-4} \cline{6-8} \cline{7-8} \cline{8-8} \cline{10-12} \cline{11-12} \cline{12-12} 
 & {\small{}X=1} & {\small{}X=0} & {\small{}Total} &  & {\small{}X=1} & {\small{}X=0} & {\small{}Total} &  & {\small{}X=1} & {\small{}X=0} & {\small{}Total}\tabularnewline
\hline 
{\small{}D=1} & {\small{}41} & {\small{}78} & {\small{}120} &  & {\small{}4} & {\small{}16} & {\small{}19} &  & {\small{}45} & {\small{}94} & {\small{}139}\tabularnewline
{\small{}D=0} & \textcolor{red}{\small{}180} & {\small{}473} & {\small{}652} &  & \textcolor{red}{\small{}77} & {\small{}473} & {\small{}550} &  & {\small{}257} & {\small{}945} & {\small{}1202}\tabularnewline
\hline 
{\small{}Total{*}} & {\small{}221} & {\small{}551} & {\small{}772} &  & {\small{}81} & {\small{}488} & {\small{}569} &  & {\small{}302} & {\small{}1039} & {\small{}1341}\tabularnewline
\hline 
\multicolumn{12}{l}{{\scriptsize{}{*}Note: Row and column totals in Z strata may not sum
because of rounding.}}\tabularnewline
\end{tabular}
```
## Overview {.h2center}

### [Why Bias Analysis?]{.gray}

<br>

### **Deterministic Bias Analysis**

#### [Unmeasured confounding]{.gray}

#### **Misclassification**

#### [Selection bias]{.gray}

<br>

### [Probabilistic Bias Analysis]{.gray}

<br>

### [Record-level Implementation]{.gray}

<br>

### [Summary]{.gray}

## Bias analysis for misclassification

<br>

> "In epidemiology, victories are few and at this point a whole field may be on the verge of propagating pathological science, which means they cannot get good enough resolution to identify the effects they're studying. Epidemiologists may be seeing and reporting that there are canals on Mars because they're looking at Mars through Galileo's telescope. And that's the nature of the field and all the statistical wizardry in the world isn't going to change that" -Gary Taubes, quoted in Koepsell and Weiss (2004)

## Basic quantities you already know

Exposure or disease classification table:

\begin{tabular}{ccc}
\hline 
 & \multicolumn{2}{c}{True Status of Exposure or Disease}\tabularnewline
\cline{2-3} \cline{3-3} 
Measured Exposure (Dx) Status & Positive & Negative\tabularnewline
\hline 
Positive & a & b\tabularnewline
Negative & c & d\tabularnewline
& & \tabularnewline
\end{tabular}

<br>

- Sensitivity (Se) = a / (a + c)

- Specificity (Sp) = d / (b + d)

- Positive Predictive Value (PPV) = a / (a + b)

- Negative Predictive Value (NPV) = d / (c + d)

## Relation between "true" and expected observed data

The number of individuals expected to be observed in a given study is a function of the "true" exposure status and the bias parameters (i.e., sensitivity and specificity):

```{=tex}
\begin{tabular}{cccccc}
\hline 
 & \multicolumn{2}{c}{True} &  & \multicolumn{2}{c}{Expected observed cells}\tabularnewline
\cline{1-3} \cline{2-3} \cline{3-3} \cline{5-6} \cline{6-6} 
 & {\small{}$E_{1}$} & {\small{}$E_{0}$} &  & {\small{}$E_{1}$} & {\small{}$E_{0}$}\tabularnewline
\hline 
{\small{}$D_{1}$} & {\small{}$A$} & {\small{}$B$} &  & {\small{}$a=A(Se_{D_{1}})+B(1-Sp_{D_{1}})$} & {\small{}$b=A(1-Se_{D_{1}})+B(Sp_{D_{1}})$}\tabularnewline
{\small{}$D_{0}$} & {\small{}$C$} & {\small{}$D$} &  & {\small{}$c=C(Se_{D_{0}})+D(1-Sp_{D_{0}})$} & {\small{}$d=C(1-Se_{D_{0}})+D(Sp_{D_{0}})$}\tabularnewline
& & & & & \tabularnewline
\end{tabular}
```
Who is in the observed "$a$" cell? It is a mixture of:

- Truly exposed individuals correctly classified: $A(Se_{D_{1}})$

- Truly unexposed individuals misclassified as exposed: $B(1-Sp_{D_{1}})$

:::{style="text-align: center;"}
[Note that observed data *implicitly* assumes 100% Se and Sp]{.red}
:::

## 
- Suppose we have 85% Se and 95% Sp, which is [non-differential]{.red} with respect to disease:

\begin{tabular}{cccccc}
\hline 
 & \multicolumn{2}{c}{True} &  & \multicolumn{2}{c}{Expected observed cells}\tabularnewline
\cline{1-3} \cline{2-3} \cline{3-3} \cline{5-6} \cline{6-6} 
 & {\small{}$E_{1}$} & {\small{}$E_{0}$} &  & {\small{}$E_{1}$} & {\small{}$E_{0}$}\tabularnewline
\hline 
{\small{}$D_{1}$} & $200$ & {\small{}$100$} &  & {\small{}$200(.85)+100(.05)=175$} & {\small{}$200(.15)+100(.95)=125$}\tabularnewline
{\small{}$D_{0}$} & $800$ & {\small{}$900$} &  & {\small{}$800(.85)+900(.05)=725$} & {\small{}$800(.15)+900(.95)=975$}\tabularnewline
\hline 
 & $1000$ & $1000$ &  & $900$ & $1100$\tabularnewline
& & & & & \tabularnewline
\end{tabular}

The observed $a$ cell has 175 individuals, of which:

- 170 ($200\times0.85$) are truly exposed and correctly classified:
    $A(Se_{D_{1}})$

- 5 $(100\times0.05)$ are truly unexposed but misclassified:
    $B(1-Sp_{D_{0}})$

:::columns
::: {.column width="35%"}
$RR_{true}=\dfrac{200/1000}{100/900}=2.0$
:::
::: {.column width="65%"}
$RR_{obs}=\dfrac{175/900}{125/1100}=1.7$
:::
:::

## Going from observed to "true" data

- We often have "observed" data and want to know what the corrected effect would be.

- Re-arrange the equations above to go from "observed" to "true" cells:

- Recall that the observed $a$ cell is: $a=A(Se_{D_{1}})+B(1-Sp_{D_{1}})$, and we know that the "true" B cell must be $B=D_{1Tot}-A$

- Now we can substitute and write $a=A(Se_{D_{1}})+(D_{1Tot}-A)(1-Sp_{D_{1}})$ and solve for $A$:

<br>

 $\begin{aligned}
a & = A(Se_{D1})+D_{1Tot}-A-D_{1Tot}(Sp_{D1})+A(Sp_{D1})\\
a-D_{1Tot}+D_{1Tot}(Sp_{D1}) & = A(Se_{D1})-A+A(Sp_{D1})\\
a-D_{1Tot}(1-Sp_{D1}) & = A(Se_{D1}-1+Sp_{D1})\\
\frac{a-D_{1Tot}(1-Sp_{D1})}{(Se_{D1}-1+Sp_{D1})} & = A\end{aligned}$

## Going from observed to "true" data

\begin{tabular}{ccccccc}
\hline 
 & \multicolumn{3}{c}{Observed} &  & \multicolumn{2}{c}{Corrected}\tabularnewline
\cline{1-4} \cline{2-4} \cline{3-4} \cline{4-4} \cline{6-7} \cline{7-7} 
 & {\small{}$E_{1}$} & {\small{}$E_{0}$} & Total &  & {\small{}$E_{1}$} & {\small{}$E_{0}$}\tabularnewline
\hline 
{\small{}$D_{1}$} & {\small{}$a$} & {\small{}$b$} & {\small{}$D_{1Tot}$} &  & $\dfrac{a-D_{1Tot}(1-Sp_{D_{1}})}{Se_{D_{1}}-(1-Sp_{D_{1}})}$ & {\small{}$D_{1Tot}-A$}\tabularnewline
{\small{}$D_{0}$} & {\small{}$c$} & {\small{}$d$} & {\small{}$D_{0Tot}$} &  & $\dfrac{c-D_{0Tot}(1-Sp_{D_{0}})}{Se_{D_{0}}-(1-Sp_{D_{0}})}$ & {\small{}$D_{0T}-C$}\tabularnewline
& & & & & & \tabularnewline
\end{tabular}

In our earlier example Se=85% and Sp=95%, we observed $a=175$, so to get the "true" estimate we have:

$$A=\frac{a-D_{1Tot}(1-Sp_{D1})}{(Se_{D1}-1+Sp_{D1})}=\frac{175-300(0.05)}{(0.85-1+0.95)}=200$$

## What can be done about misclassification?

- Validation study
  - Measurement using a "gold standard" on a random sub-sample.
  - Need to make assumptions about who "complies" with additional measurements and participation.
  - Might still be infeasible to conduct a validation study for other reasons (e.g., data already collected).
  - However, for many kinds of exposures (e.g., Personality tests, social class, etc.) there are no "gold standard" tests.


- One option in these cases is to try and quantify the potential role that misclassification may have played in your study.
- Example of coronary heart disease and personality types (Western Collaborative Group Study):
- If misclassification is ignored entirely, you are assuming 100%
        Sensitivity and 100% Specificity.
        
## Example: non-differential misclassification of exposure

Example of coronary heart disease ($D$) and personality types ($E$):

\begin{tabular}{ccccccc}
\hline 
 & \multicolumn{2}{c}{True} &  & \multicolumn{2}{c}{Observed cells} & \tabularnewline
\cline{1-3} \cline{2-3} \cline{3-3} \cline{5-7} \cline{6-7} \cline{7-7} 
 & {\small{}$E_{1}$} & {\small{}$E_{0}$} &  & {\small{}$E_{1}$} & {\small{}$E_{0}$} & Total\tabularnewline
\hline 
{\small{}$D_{1}$} & {\small{}$A$} & {\small{}$B$} &  & 150 & 107 & 257\tabularnewline
{\small{}$D_{0}$} & {\small{}$C$} & {\small{}$D$} &  & 1277 & 1620 & 2897\tabularnewline
& & & & \tabularnewline
\end{tabular}

$$RR_{obs}=(150/1427)/(107/1727)=1.7$$

- Suppose we have good reasons for assuming 80% Se and 90% Sp.

- What is the true association?

## Calculating "true" values from observed

In our example Se=80% and Sp=90%, we observed $a=150$, so to get the "true" estimate for $A$ we have:

$$A=\frac{a-D_{1Tot}(1-Sp_{D1})}{(Se_{D1}-1+Sp_{D1})}=\frac{150-257(0.10)}{(0.80-1+0.90)}=177.6$$
<br>

Similar calculations for "true" $C$:

$$C=\frac{c-D_{0Tot}(1-Sp_{D0})}{(Se_{D0}-1+Sp_{D0})}=\frac{1277-2897(0.10)}{(0.80-1+0.90)}=1410.4$$

## Example: non-differential misclassification of exposure

- True $B$ and $D$ are then calculated by subtraction from marginal
    totals:

$B=D_{1Tot}-a=257-177.5=79.4$

$D=D_{0Tot}-b=2897-1410.4=1486.6$

- Now fill in the "true" table:

\begin{tabular}{ccccccc}
\hline 
 & \multicolumn{2}{c}{True} &  & \multicolumn{2}{c}{Observed cells} & \tabularnewline
\cline{1-3} \cline{2-3} \cline{3-3} \cline{5-7} \cline{6-7} \cline{7-7} 
 & {\small{}$E_{1}$} & {\small{}$E_{0}$} &  & {\small{}$E_{1}$} & {\small{}$E_{0}$} & Total\tabularnewline
\hline 
{\small{}$D_{1}$} & 177.6 & 79.4 &  & 150 & 107 & 257\tabularnewline
{\small{}$D_{0}$} & 1410.4 & 1486.6 &  & 1277 & 1620 & 2897\tabularnewline
& & & & & & \tabularnewline
\end{tabular}
<br>

$$RR_{true}=(177.6/1588)/(79.4/1566)=2.2$$

## Simple implementation via `episensr`^[See package by @Haine:2021aa]

:::: {.columns}

::: {.column width="35%"}
```{r, echo=T, results='hide'}
library(episensr)
# observed data
misclassification(
  matrix(c(150, 107, 
           1277, 1620),
  dimnames = list(c("D+", "D-"),
  c("E+", "E- ")),
  nrow = 2, byrow = TRUE),
  type = "exposure",

# bias parameters
  bias_parms = c(0.80, 0.80, 
                 0.90, 0.90))
```
:::

::: {.column width="65%"}

```{r, echo=F}
misclassification(matrix(c(150, 107, 1277, 1620),
  dimnames = list(c("D+", "D-"),
  c("E+", "E- ")),
  nrow = 2, byrow = TRUE),
  type = "exposure",
  bias_parms = c(0.80, 0.80, 0.90, 0.90))
```
:::

::::

## Misclassification of confounders

- Even if exposure and disease have 100% Se and 100% Sp, misclassification of confounders can lead to biased estimates.

- If the confounding is strong and the exposure-disease relation is weak or null, confounder misclassification can produce misleading results, even if independent and non-differential.

- Need bias parameters for misclassified confounder data (validation, literature, etc.)

## Stratified analysis implementation

- Estimates for Se and Sp are applied to measurement of confounder rather than exposure.^[See examples in Ch.6 of @Fox:2022aa.]

```{r}
#| fig-align: center
knitr::include_graphics(here("images", "fox-misclass-conf.png"))
```

## Example: Effect of coffee consumption on bladder cancer^[In line note.] 

We might draw a model like this, indicating that true smoking status is unmeasured but may still confound the association between coffee and bladder cancer:
    
```{r, engine = 'tikz'}
#| fig.align: center
\begin{tikzpicture}[shorten > = 1pt, line width=1pt]
\tikzstyle{every node} = [rectangle, fill=white, draw=none]
\node (st) at  (0,0) [align=center] {Smoke\textsubscript{True}};
\node (so) at  (0,2) [align=center] {Smoke*\textsubscript{Obs}};
\node (a) at  (2.5,0) [align=center] {Coffee};
\node (y) at (5,0) [align=center] {Cancer};
\foreach \from/\to in {st/so, st/a, a/y}
  \draw [->] (\from) -- (\to);
\draw [->] (st) to [bend left=35] (y);
\end{tikzpicture}
```

## 
```{r}
#| fig-align: center
knitr::include_graphics(here("images", "coffee-cancer-crude.png"))
```
$$OR_{crude}=1.8\quad \textrm{and} \quad OR_{MHadj}=1.5\quad 95\%\text{CI}=[1.1,2.0]$$
```{r}
#| fig-align: center
knitr::include_graphics(here("images", "coffee-cancer-adj.png"))
```
$$OR_{MHadj}=1.3\quad 95\%\text{CI}=[0.95,1.7]$$
## Overview {.h2center}

### [Why Bias Analysis?]{.gray}

<br>

### **Deterministic Bias Analysis**

#### [Unmeasured confounding]{.gray}

#### [Misclassification]{.gray}

#### **Selection bias**

<br>

### [Probabilistic Bias Analysis]{.gray}

<br>

### [Record-level Implementation]{.gray}

<br>

### [Summary]{.gray}

## Bias analysis for selection bias

## Differential baseline participation

:::: {.columns}

::: {.column width="40%"}

What do you need?

- Selection probabilities  
- Ideally, by exposure *and* disease status.  

Where can you get it?

- Validation (internal or external).
- Internal probably better.
- Educated guesses (largely based on experience or prior data).

:::

::: {.column width="60%"}
Example: mobile phone use and uveal melanoma^[Example from @Stang:2009aa described in @Fox:2022aa]
```{r}
#| fig-align: center
#| out-width: 80%
knitr::include_graphics(here("images", "stang.png"))
```
:::

::::

##
\begin{tabular}{cccccccc}
\hline 
 & \multicolumn{2}{c}{Participants} &  & \multicolumn{2}{c}{Non-participants+Q} &  & Refusals\tabularnewline
\cline{2-3} \cline{3-3} \cline{5-6} \cline{6-6} \cline{8-8} 
 & E+ & E- &  & E+ & E- &  & ?\tabularnewline
\hline 
Cases & 136 & 107 &  & 3 & 7 &  & 17\tabularnewline
Controls & 297 & 165 &  & 72 & 212 &  & 379\tabularnewline
\hline 
\end{tabular}

- OR among participants: (136/297)/(107/165) = 0.71

- OR among non-participants w/Q: (3/72)/(7/212) = 1.25

- Who's missing? 3 exposed cases we know from the questionnaire, but what about the other non-participants? Assume the exposure distribution similar to the other non-participants (3/10)\*17. Same for controls.

- Now we can get an adjusted OR:

$OR_{adj}=\dfrac{136+3+(3/10)*17}{297+72+(72/284)*379}/\dfrac{107+7+(7/10)*17}{165+212+(212/284)*379}=1.62$

## Using selection probabilities

- More generally, if we know or can estimate, or have reasonable guesses about the selection probabilities, we can create an adjusted OR using the selection probabilities:

    -   E+ Cases = 136/(136+3+(3/10)\*17) = 0.96

    -   E- Cases = 107/(107+7+(7/10)\*17) = 0.85

    -   E+ Controls = 297/(297+72+(72/284)\*379) = 0.64

    -   E- Controls = 165/(165+212+(212/294)\*379) = 0.25

$$OR_{adj}=\hat{OR}\times\dfrac{S_{caseE-}\times S_{controlE+}}{S_{caseE+}\times S_{controlE-}}$$

$$OR_{adj}=0.71\times\dfrac{0.85\times0.64}{0.94\times0.25}=1.63$$

## Using inverse-probability of selection weighting

- More generally, if we know or can estimate, or have reasonable guesses about the selection probabilities, we can create an adjusted OR using the selection probabilities:

    -   E+ Cases = 136/(136+3+(3/10)\*17) = 0.96

    -   E- Cases = 107/(107+7+(7/10)\*17) = 0.85

    -   E+ Controls = 297/(297+72+(72/284)\*379) = 0.64

    -   E- Controls = 165/(165+212+(212/294)\*379) = 0.25

$$OR_{adj}=\hat{OR}\times\dfrac{S_{caseE-}\times S_{controlE+}}{S_{caseE+}\times S_{controlE-}}$$

$$OR_{adj}=0.71\times\dfrac{0.85\times0.64}{0.94\times0.25}=1.63$$

## Differential loss-to-follow up

- How to account for potential bias among those lost?

- Example of impact of treatment guidelines on breast cancer mortality.

- Overall loss-to-follow of 13%, initial baseline treatment status of those lost is known.

```{r, engine = 'tikz'}
#| fig.align: center
\begin{tikzpicture}[shorten > = 1pt, line width=1pt]
\tikzstyle{every node} = [rectangle, fill=white, draw=none]
\node (l) at  (3.5,1.5) [align=center, draw=black] {Not\\Lost};
\node (h) at  (0,1.5) [align=center] {Hospital\\type};
\node (t) at  (2,0) [align=center] {Treatment\\guidelines};
\node (y) at (5,0) [align=center] {Breast\\Cancer};
\foreach \from/\to in {t/y, h/l, t/l, h/t}
  \draw [->] (\from) -- (\to);
\draw [->] (h) to [bend right=60] (y);
\end{tikzpicture}
```

## 
How to estimate the rates among those lost?

\begin{tabular}{cccccc}
\hline 
 & \multicolumn{2}{c}{With follow-up} &  & \multicolumn{2}{c}{Lost to follow-up}\tabularnewline
\cline{2-3} \cline{3-3} \cline{5-6} \cline{6-6} 
 & E+ & E- &  & E+ & E-\tabularnewline
\hline 
Deaths & 40 & 65 &  &  & \tabularnewline
Persons & 104 & 286 &  & 13 & 46\tabularnewline
Person-years & 687 & 2560 &  &  & \tabularnewline
Crude rate & 5.8/100py & 2.5/100py &  &  & \tabularnewline
Crude RD & 3.3/100py & 0 &  &  & \tabularnewline
Crude RR & 2.3 & 1.0 &  &  & \tabularnewline
& & & & & \tabularnewline
\end{tabular}

<br>

- First, let's assume that they would have accrued similar person
    years as those with follow-up:

##
\begin{tabular}{cccccc}
\hline 
 & \multicolumn{2}{c}{With follow-up} &  & \multicolumn{2}{c}{Lost to follow-up}\tabularnewline
\cline{2-3} \cline{3-3} \cline{5-6} \cline{6-6} 
 & E+ & E- &  & E+ & E-\tabularnewline
\hline 
Deaths & 40 & 65 &  &  & \tabularnewline
Persons & \textcolor{red}{104} & \textcolor{blue}{286} &  & 13 & 46\tabularnewline
Person-years & \textcolor{red}{687} & \textcolor{blue}{2560} &  & \textcolor{red}{85.9} & \textcolor{blue}{411.7} \tabularnewline
Crude rate & 5.8/100py & 2.5/100py &  &  & \tabularnewline
Crude RD & 3.3/100py & 0 &  &  & \tabularnewline
Crude RR & 2.3 & 1.0 &  &  & \tabularnewline
& & & & & \tabularnewline
\end{tabular}

:::{style="text-align: center;"}
$PY_{E+}=\color{red}{(687/104)\times{13}=85.9py}$ 

$PY_{E-}=\color{blue}{(2560/286)\times{46}=411.7py}$
:::

- What should we assume about their mortality risks?
- What if we assume similar to those with follow-up?

## 
- Missing individuals were diagnosed at 2 specific hospitals, so use [observed rates]{.blue} among those non-missing in hospitals where those LTF were diagnosed

:::{style="text-align: center;"}
$Deaths_{E+}=\color{blue}{.049}\color{black}{\times{85.9}=}\color{red}{4.2}$ 

$Deaths_{E-}=\color{blue}{.045}\color{black}{\times{411.7}=}\color{red}{18.7}$ 
:::

\begin{tabular}{cccccc}
\hline 
 & \multicolumn{2}{c}{At 2 hospitals} &  & \multicolumn{2}{c}{Estimated for those lost}\tabularnewline
\cline{2-3} \cline{3-3} \cline{5-6} \cline{6-6} 
 & E+ & E- &  & E+ & E-\tabularnewline
\hline 
Deaths & 3 & 5 &  & \textcolor{red}{4.2} & \textcolor{red}{18.7}\tabularnewline
Person-years & 60.8 & 110.2 &  & 85.9 & 411.7\tabularnewline
Crude rate & \textcolor{blue}{4.9/100py} & \textcolor{blue}{4.5/100py} &  &  & \tabularnewline
Crude RD & 0.4/100py & 0 &  &  & \tabularnewline
Crude RR & 1.1 & 1.0 &  &  & \tabularnewline
& & & & & \tabularnewline
\end{tabular}

## Bias-corrected estimates (with assumptions)

\begin{tabular}{cccccc}
\hline 
 & \multicolumn{2}{c}{With follow-up} &  & \multicolumn{2}{c}{Lost to follow-up}\tabularnewline
\cline{2-3} \cline{3-3} \cline{5-6} \cline{6-6} 
 & E+ & E- &  & E+ & E-\tabularnewline
\hline 
Deaths & 40 & 65 &  & 4.2  & 18.7 \tabularnewline
Persons & 104 & 286 &  & 13 & 46\tabularnewline
Person-years & 687 & 2560 &  & 85.9 & 411.7 \tabularnewline
Crude rate & 5.8/100py & 2.5/100py &  &  & \tabularnewline
Crude RD & 3.3/100py & 0 &  &  & \tabularnewline
Crude RR & 2.3 & 1.0 &  &  & \tabularnewline
& & & & & \tabularnewline
\end{tabular}

:::{style="text-align: center;"}

$IR_{E+}=(40 + 4.2)/(687py+85.9py) = 5.7/100py$ 

$IR_{E-}=(65+18.7)(2560py+411.7py)=2.8/100py$

$RD=2.9/100py\quad \text{and} \quad RR=2.0$ 

:::

## Bias-corrected estimates (bounds)
- Worst case scenario still suggests some impact.

\begin{tabular}{cccccc}
\hline 
 & \multicolumn{2}{c}{With follow-up} &  & \multicolumn{2}{c}{Lost to follow-up}\tabularnewline
\cline{2-3} \cline{3-3} \cline{5-6} \cline{6-6} 
 & E+ & E- &  & E+ & E-\tabularnewline
\hline 
Deaths & 40 & 65 &  & \textcolor{blue}{0}  & \textcolor{blue}{46} \tabularnewline
Persons & 104 & 286 &  & 13 & 46\tabularnewline
Person-years & 687 & 2560 &  & 85.9 & 411.7 \tabularnewline
Crude rate & 5.8/100py & 2.5/100py &  &  & \tabularnewline
Crude RD & 3.3/100py & 0 &  &  & \tabularnewline
Crude RR & 2.3 & 1.0 &  &  & \tabularnewline
& & & & & \tabularnewline
\end{tabular}

:::{style="text-align: center;"}

$IR_{E+}=(40 + 0)/(687py+85.9py) = 5.2/100py$ 

$IR_{E-}=(65+46)(2560py+411.7py)=3.7/100py$

$RD=1.4/100py\quad \text{and} \quad RR=1.4$ 

:::

## IP weighting for selection bias
[lash figure]

## Break!  `r emo::ji("coffee")` {.h2center}

```{r, echo=F}
countdown(minutes = 10, 
          left = 0, right = 0, bottom = "15%", top = "15%",
          padding = "50px",
          margin = "5%",
          font_size = "7em",
          color_text= '#f5bc6c')
```

## Overview {.h2center}

### [Why Bias Analysis?]{.gray}

<br>

### [Deterministic Bias Analysis]{.gray}

#### [Unmeasured confounding]{.gray}

#### [Misclassification]{.gray}

#### [Selection bias]{.gray}

<br>

### **Probabilistic Bias Analysis**

<br>

### [Record-level Implementation]{.gray}

<br>

### [Summary]{.gray}

## Multidimensional bias analysis

-   Often, bias parameters are only educated guesses.

-   Multidimensional bias analysis uses a range of plausible values for
    bias parameters.

-   Especially useful if there are no known validation data for your
    parameters of interest.

. . . 

What to vary?



-   Unmeasured confounding

    -   Vary strength of Z-Exp and Z-Dis associations.

-   Misclassification:

    -   Range of Se/Sp values, including differential.

-   Selection bias

    -   Range of different selection proportions or selection bias
        factor.
        
## Example of multidimensional bias analysis

## Probabilistic

```{css, echo=FALSE}
.longcode {
height: 800px;
width: 1500px;
}
```
## Example: Unmeasured confounding of resins and cancer
- Setup using the `episensr` package
```{r, cache=T, echo=T}
#| class-source: longcode
#| classes: longcode
# set the seed for reproducible results
set.seed(39569)

# define the observed 2x2 data
pc <- probsens.conf(matrix(c(45, 94, 257, 945),
  dimnames = list(c("D+", "D-"), c("D+", "D-")), nrow = 2, byrow = TRUE),

# number of replications
  reps = 5000, 

# bias parameters and distributions

# prevalence of U among exposed
prev.exp = list("triangular", c(.6, .8, .7)),

# prevalence of U among unexposed
prev.nexp = list("triangular", c(.3, .5, .4)),

# association of U with outcome
risk = list("log-normal", c(1.522, 0.216)), 

# correlation between exposure prevalences 
corr.p = 0.01)
```

## Probability distributions for each parameter

```{r, echo=F}
#| fig.align: center
p1 <- data.frame(pc$sim.df$p1)
p0 <- data.frame(pc$sim.df$p0)
rrcd <- data.frame(pc$sim.df$RR.cd)
bcor <- data.frame(pc$sim.df$tot.OR)

pba_p1 <- ggplot(p1, aes(x=pc.sim.df.p1)) + theme_classic() + 
  geom_histogram(binwidth=0.005, color="#5e3c99", fill="#b2abd2") +
  labs(x="P(Confounder in E+)", y="No. observations")

pba_p0 <- ggplot(p0, aes(x=pc.sim.df.p0)) + theme_classic() + 
  geom_histogram(binwidth=0.005, color="#5e3c99", fill="#b2abd2") +
  labs(x="P(Confounder in E-)", y="No. observations")

pba_rrcd <- ggplot(rrcd, aes(x=pc.sim.df.RR.cd)) + theme_classic() + 
  geom_histogram(binwidth=0.2, color="#5e3c99", fill="#b2abd2") +
  labs(x="Confounder-Disease RR", y="No. observations")

pba_p1 + pba_p0 + pba_rrcd
```

## Generates a distribution of corrected estimates
```{r, echo=F}
#| fig.align: center
ggplot(bcor, aes(x=pc.sim.df.tot.OR)) + theme_classic() + 
  geom_histogram(binwidth=0.02, color="#5e3c99", fill="#b2abd2") +
  labs(x="Bias-corrected OR", y="No. observations")
```

## Bias-corrected estimates
```{r, echo=F}
oor <- as.numeric(gsub("\\D+", ".", pc$obs.measures[2,]))
cors <- as.numeric(gsub("\\D+", ".", pc$adj.measures[3,]))
corsr <- as.numeric(gsub("\\D+", ".", pc$adj.measures[4,]))
bcor_t <- data.frame(rbind(oor, cors, corsr))
row.names(bcor_t) <- c("OR:Crude", "OR:Corrected-systematic error", "OR:Corrected-systematic and random error")
kbl(bcor_t, col.names = c("Median", "2.5th pctile", "97.5th pctile"),digits = 2) %>% kable_styling()
```

## References

